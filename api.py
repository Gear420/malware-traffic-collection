#!/usr/bin/env python
# -*- coding: utf-8 -*-


import os
import requests

post_url = "https://www.hybrid-analysis.com/api/v2/submit/file"
api_key = "7mr997h188fe25ccjou62hczf23cce72se4md5gb8b7a31483fltg2abc94dbedc"
get_url = "https://www.hybrid-analysis.com/api/v2/report/"
file_list = []
jobids = []


def get_pcap(job_id, filename):
	url = get_url + job_id + '/pcap'
	headers = {
		"User-Agent": 'Falcon Sandbox',
		"api-key": "7mr997h188fe25ccjou62hczf23cce72se4md5gb8b7a31483fltg2abc94dbedc",
		"accept": "application/octet-stream",
		"accept-encoding": "gzip"
	}
	r = requests.get(url, headers=headers)
	with open("pcap/" + filename, 'wb') as f:
		f.write(r.content)


import json
import subprocess


def submit_file(file, enviroment_id):
	result = subprocess.check_output(
		"curl -X 'POST' \
'https://www.hybrid-analysis.com/api/v2/submit/file' \
-H 'accept: application/json' \
-H 'user-agent: Falcon Sandbox' \
-H 'api-key: 7mr997h188fe25ccjou62hczf23cce72se4md5gb8b7a31483fltg2abc94dbedc' \
-H 'Content-Type: multipart/form-data' \
-F 'file=@{file};type=application/x-msdownload' \
-F 'environment_id=@{env_id}'".format(file=file, env_id=enviroment_id),
		shell=True)
	s = json.loads(result)
	
	if 'job_id' in s:
		return s['job_id']
	else:
		return None


def walkFile(file):
	for root, dirs, files in os.walk(file):
		for f in files:
			# print(os.path.join(root, f))
			file_list.append(f)


if __name__ == "__main__":
	walkFile("malwares/")
	submit_file_list = []
	for file in file_list:
		submit_file_list.append("malwares/" + file)
	print(submit_file_list)
	job_ids = []
	# job_ids = ['5d0b2db20288384b939dfad3', '5ca6d6d5038838370e294665', '60dcafb60990de33880dc5d2',  '586d05e9aac2edcc57302820', '57ae435554a0ade0f1893f3c', '60eae3a96dd64861032b8f7b', '5882b4e2aac2ed1f1c53a098', '57ae430854a0ade0f1893f39', '57ae42e5aac2eded28c5c310', '60eae3c11a582424c7118cee', '60eae3c351777809a668a2c7', '57ae434254a0ade0f1893f3b', '57ae431b54a0ade0f1893f3a', '60eae3cbb06f5445fe409490', '5ccba0f50388380b095f8169', '5e1dd6858fc3ee398b6bd46b', '573c153eaac2ed8f1f7b23c8', '60eae3e978badf05a83a2551', '60eae3ebe50fb25ba84cd47e', '60eae3f0b1c2cb112d294f78', '60eae3f73b91741c872e57b4', '60eae3fad682a923347834e9', '60eae3fc25653f470116d6dc']
	environment_id = 100
	i = 0
	for file in submit_file_list:
		job_id = submit_file(file, environment_id)
		get_pcap(job_id, str(i) + '.pcap')
		i = i + 1
		job_ids.append(job_id)



